document.addEventListener(
  "DOMContentLoaded",
  (async function () {
    if ("undefined" == typeof window) return;
    const e = "http://localhost:3000/api/pixel",
      t = document.currentScript;
    var n = [];
    let a = null;
    if (!t) return;
    const o = t.getAttribute("data-websiteid");
    if (!o || "string" != typeof o) return;
    let i = performance.now(),
      r = 0;
    const c = new URLSearchParams(location.search),
      s = c.get("utm_source"),
      l = c.get("utm_campaign"),
      p = history.pushState,
      h = history.replaceState,
      d = (e, t) =>
        JSON.stringify({
          type: e.toUpperCase(),
          screenWidth: window.innerWidth,
          website_id: o,
          url: location.href,
          utm_campaign: l,
          utm_source: s,
          ...t,
        });
    if (
      !(
        await fetch(e + "/session?id=" + o, {
          method: "POST",
          body: d("session"),
          headers: { "Content-Type": "application/json" },
          keepalive: !0,
        })
      ).ok
    )
      return;
    const u = (t, n, a) => {
        const o = d(t, n);
        a
          ? fetch(e + "/collect", {
              method: "POST",
              body: d(t, n),
              headers: { "Content-Type": "application/json" },
              keepalive: !0,
            }).catch(() => {})
          : navigator.sendBeacon
            ? navigator.sendBeacon(e + "/collect", o)
            : fetch(e + "/collect", {
                method: "POST",
                body: d(t, n),
                headers: { "Content-Type": "application/json" },
                keepalive: !0,
              }).catch(() => {});
      },
      m = () => {
        a || (a = setInterval(() => u("heartbeat"), 15e3));
      },
      y = () => {
        n.push(location.href),
          n.length >= 5 && (u("path_change", { path_history: n }), (n = []));
      };
    (history.pushState = function (...e) {
      p.apply(this, e), y();
    }),
      (history.replaceState = function (...e) {
        h.apply(this, e), y();
      }),
      u("page_view"),
      m();
    let f = null;
    document.addEventListener("visibilitychange", () => {
      "hidden" === document.visibilityState
        ? (a && (clearInterval(a), (a = null)),
          (r += performance.now() - i),
          (f = setTimeout(() => {
            u("page_blur", { active_time: Math.round(r), path_history: n }),
              f && (clearTimeout(f), (f = null));
          }, 5e3)))
        : ((i = performance.now()),
          (f = setTimeout(() => {
            u("page_unblur"), f && (clearTimeout(f), (f = null)), m();
          }, 1e3)));
    }),
      window.addEventListener("popstate", y),
      window.addEventListener("pagehide", () => {
        console.log(n),
          (r += performance.now() - i),
          u("page_exit", { active_time: Math.round(r), path_history: n });
      });
  })(),
);
